version: '3.8'

# G3TI RTCC-UIP Docker Compose Configuration
# Real Time Crime Center Unified Intelligence Platform
#
# This configuration provides the complete development stack:
# - Backend API (FastAPI)
# - Frontend (Next.js)
# - Neo4j (Graph Database)
# - Elasticsearch (Search Engine)
# - Redis (Cache & Pub/Sub)
# - Celery Worker (Background Tasks)

services:
  # =============================================================================
  # Backend API Service
  # =============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-backend
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-use-strong-key}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - REDIS_URL=redis://redis:6379/0
      - CORS_ORIGINS=http://localhost:3000,http://frontend:3000
    depends_on:
      neo4j:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - backend-cache:/app/.cache
    networks:
      - rtcc-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/system/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # =============================================================================
  # Frontend Service
  # =============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rtcc-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
      - NEXT_PUBLIC_WS_URL=ws://localhost:8000/api/v1/realtime/ws/events
      - NEXT_PUBLIC_MAPBOX_TOKEN=${MAPBOX_TOKEN:-}
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
      - frontend-next:/app/.next
    networks:
      - rtcc-network
    restart: unless-stopped

  # =============================================================================
  # Neo4j Graph Database
  # =============================================================================
  neo4j:
    image: neo4j:5.15-community
    container_name: rtcc-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512m
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    networks:
      - rtcc-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # =============================================================================
  # Elasticsearch Search Engine
  # =============================================================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: rtcc-elasticsearch
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - cluster.name=rtcc-cluster
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - rtcc-network
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # =============================================================================
  # Redis Cache & Message Broker
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: rtcc-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - rtcc-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # =============================================================================
  # Celery Worker (Background Tasks)
  # =============================================================================
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-celery-worker
    command: celery -A app.celery_app worker --loglevel=info
    environment:
      - ENVIRONMENT=development
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-use-strong-key}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    depends_on:
      - backend
      - redis
    volumes:
      - ./backend:/app
    networks:
      - rtcc-network
    restart: unless-stopped

  # =============================================================================
  # Celery Beat (Scheduled Tasks)
  # =============================================================================
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-celery-beat
    command: celery -A app.celery_app beat --loglevel=info
    environment:
      - ENVIRONMENT=development
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-use-strong-key}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    depends_on:
      - celery-worker
    volumes:
      - ./backend:/app
    networks:
      - rtcc-network
    restart: unless-stopped

# =============================================================================
# Networks
# =============================================================================
networks:
  rtcc-network:
    driver: bridge
    name: rtcc-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  neo4j-data:
    name: rtcc-neo4j-data
  neo4j-logs:
    name: rtcc-neo4j-logs
  elasticsearch-data:
    name: rtcc-elasticsearch-data
  redis-data:
    name: rtcc-redis-data
  backend-cache:
    name: rtcc-backend-cache
  frontend-node-modules:
    name: rtcc-frontend-node-modules
  frontend-next:
    name: rtcc-frontend-next
