version: '3.8'

# G3TI RTCC-UIP Docker Compose Configuration
# Real Time Crime Center Unified Intelligence Platform
#
# This configuration provides the complete development stack:
# - Backend API (FastAPI)
# - Frontend (Next.js)
# - Neo4j (Graph Database)
# - Elasticsearch (Search Engine)
# - Redis (Cache & Pub/Sub)
# - Celery Worker (Background Tasks)

services:
  # =============================================================================
  # Backend API Service
  # =============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-backend
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-use-strong-key}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - NEO4J_SECONDARY_URI=bolt://neo4j-secondary:7687
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - REDIS_URL=redis://redis:6379/0
      - REDIS_SECONDARY_URL=redis://redis-secondary:6379/0
      - CORS_ORIGINS=http://localhost:3000,http://frontend:3000
      - OPS_HEALTH_CHECK_INTERVAL=30
      - OPS_FAILOVER_THRESHOLD=3
      - OPS_REDUNDANCY_MODE=hot
    depends_on:
      neo4j:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - backend-cache:/app/.cache
    networks:
      - rtcc-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/ops/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    stop_grace_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # =============================================================================
  # Frontend Service
  # =============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rtcc-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
      - NEXT_PUBLIC_WS_URL=ws://localhost:8000/api/v1/realtime/ws/events
      - NEXT_PUBLIC_MAPBOX_TOKEN=${MAPBOX_TOKEN:-}
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
      - frontend-next:/app/.next
    networks:
      - rtcc-network
    restart: unless-stopped

  # =============================================================================
  # Neo4j Graph Database
  # =============================================================================
  neo4j:
    image: neo4j:5.15-community
    container_name: rtcc-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512m
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    networks:
      - rtcc-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # =============================================================================
  # Elasticsearch Search Engine
  # =============================================================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: rtcc-elasticsearch
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - cluster.name=rtcc-cluster
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - rtcc-network
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # =============================================================================
  # Redis Cache & Message Broker
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: rtcc-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - rtcc-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # =============================================================================
  # Celery Worker (Background Tasks)
  # =============================================================================
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-celery-worker
    command: celery -A app.celery_app worker --loglevel=info
    environment:
      - ENVIRONMENT=development
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-use-strong-key}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    depends_on:
      - backend
      - redis
    volumes:
      - ./backend:/app
    networks:
      - rtcc-network
    restart: unless-stopped

  # =============================================================================
  # Celery Beat (Scheduled Tasks)
  # =============================================================================
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-celery-beat
    command: celery -A app.celery_app beat --loglevel=info
    environment:
      - ENVIRONMENT=development
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-use-strong-key}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    depends_on:
      - celery-worker
    volumes:
      - ./backend:/app
    networks:
      - rtcc-network
    restart: unless-stopped

  # =============================================================================
  # Neo4j Secondary (Redundancy - Hot Standby)
  # Phase 14: Operational Continuity
  # =============================================================================
  neo4j-secondary:
    image: neo4j:5.15-community
    container_name: rtcc-neo4j-secondary
    ports:
      - "7475:7474"
      - "7688:7687"
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=256m
      - NEO4J_dbms_memory_heap_max__size=512m
      - NEO4J_dbms_memory_pagecache_size=256m
    volumes:
      - neo4j-secondary-data:/data
    networks:
      - rtcc-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    profiles:
      - redundancy

  # =============================================================================
  # Redis Secondary (Redundancy - Replica)
  # Phase 14: Operational Continuity
  # =============================================================================
  redis-secondary:
    image: redis:7-alpine
    container_name: rtcc-redis-secondary
    ports:
      - "6380:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --replicaof redis 6379
    volumes:
      - redis-secondary-data:/data
    networks:
      - rtcc-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    profiles:
      - redundancy

  # =============================================================================
  # Drone Telemetry Service (Phase 15)
  # Autonomous Drone Task Force Engine
  # =============================================================================
  drone-telemetry:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-drone-telemetry
    command: python -m app.drones.telemetry_service
    environment:
      - ENVIRONMENT=development
      - REDIS_URL=redis://redis:6379/0
      - DRONE_TELEMETRY_INTERVAL=100
      - DRONE_VIDEO_WEBRTC_ENABLED=true
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - rtcc-network
    restart: unless-stopped
    profiles:
      - drones

  # =============================================================================
  # Predictive AI Service (Phase 15)
  # GPU-accelerated predictive policing models
  # =============================================================================
  predictive-ai:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-predictive-ai
    command: python -m app.predictive_ai.service
    environment:
      - ENVIRONMENT=development
      - REDIS_URL=redis://redis:6379/0
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - PREDICTIVE_MODEL_PATH=/app/models
      - CUDA_VISIBLE_DEVICES=0
      - ENABLE_GPU=true
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - predictive-models:/app/models
    networks:
      - rtcc-network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    profiles:
      - predictive
      - gpu

  # =============================================================================
  # Sensor Grid Processor (Phase 15)
  # Smart Sensor Grid Integration Layer
  # =============================================================================
  sensor-grid:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-sensor-grid
    command: python -m app.sensor_grid.processor
    environment:
      - ENVIRONMENT=development
      - REDIS_URL=redis://redis:6379/0
      - SENSOR_POLLING_INTERVAL=1000
      - GUNSHOT_DETECTION_ENABLED=true
      - CROWD_DENSITY_ENABLED=true
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - rtcc-network
    restart: unless-stopped
    profiles:
      - sensors

  # =============================================================================
  # Digital Twin Renderer (Phase 15)
  # City Digital Twin Engine
  # =============================================================================
  digital-twin:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-digital-twin
    command: python -m app.digital_twin.renderer
    environment:
      - ENVIRONMENT=development
      - REDIS_URL=redis://redis:6379/0
      - DIGITAL_TWIN_UPDATE_INTERVAL=100
      - ENABLE_3D_RENDERING=true
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - building-models:/app/building_models
    networks:
      - rtcc-network
    restart: unless-stopped
    profiles:
      - digital-twin

  # =============================================================================
  # Fusion Cloud Gateway (Phase 16)
  # Multi-City / Multi-Agency Federation Service
  # =============================================================================
  fusion-cloud:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-fusion-cloud
    command: python -m app.fusion_cloud.gateway
    environment:
      - ENVIRONMENT=development
      - REDIS_URL=redis://redis:6379/0
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - FUSION_TENANT_ISOLATION=true
      - FUSION_FEDERATION_ENABLED=true
      - FUSION_CROSS_AGENCY_SHARING=true
      - FUSION_CJIS_COMPLIANCE=true
      - FUSION_ENCRYPTION_ENABLED=true
      - FUSION_ABAC_ENABLED=true
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - rtcc-network
    restart: unless-stopped
    profiles:
      - fusion

  # =============================================================================
  # Fusion Analytics Processor (Phase 16)
  # Federated Analytics Engine for Multi-City Analysis
  # =============================================================================
  fusion-analytics:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-fusion-analytics
    command: python -m app.fusion_cloud.analytics_processor
    environment:
      - ENVIRONMENT=development
      - REDIS_URL=redis://redis:6379/0
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - FUSION_HEATMAP_RESOLUTION=8
      - FUSION_CLUSTER_UPDATE_INTERVAL=300
      - FUSION_TRAJECTORY_ANALYSIS=true
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - rtcc-network
    restart: unless-stopped
    profiles:
      - fusion

  # =============================================================================
  # Threat Intel OSINT Harvester (Phase 17)
  # Global Threat Intelligence Engine - OSINT Pipeline
  # =============================================================================
  threat-intel-osint:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-threat-intel-osint
    command: python -m app.threat_intel.osint_harvester.service
    environment:
      - ENVIRONMENT=development
      - REDIS_URL=redis://redis:6379/0
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - OSINT_RSS_POLL_INTERVAL=300
      - OSINT_SOCIAL_POLL_INTERVAL=60
      - OSINT_SPIKE_DETECTION_ENABLED=true
      - OSINT_HATE_SPEECH_CLASSIFIER_ENABLED=true
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - rtcc-network
    restart: unless-stopped
    profiles:
      - threat-intel

  # =============================================================================
  # Threat Intel Dark Web Monitor (Phase 17)
  # Global Threat Intelligence Engine - Dark Web Pipeline
  # =============================================================================
  threat-intel-darkweb:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-threat-intel-darkweb
    command: python -m app.threat_intel.dark_web_monitor.service
    environment:
      - ENVIRONMENT=development
      - REDIS_URL=redis://redis:6379/0
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - DARKWEB_TOR_ENABLED=false
      - DARKWEB_KEYWORD_DETECTION_ENABLED=true
      - DARKWEB_MARKET_ANALYSIS_ENABLED=true
      - DARKWEB_SENTIMENT_SCORING_ENABLED=true
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - rtcc-network
    restart: unless-stopped
    profiles:
      - threat-intel

  # =============================================================================
  # Threat Intel Scoring Engine (Phase 17)
  # Global Threat Intelligence Engine - ML Scoring Pipeline
  # =============================================================================
  threat-intel-scoring:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-threat-intel-scoring
    command: python -m app.threat_intel.threat_scoring_engine.service
    environment:
      - ENVIRONMENT=development
      - REDIS_URL=redis://redis:6379/0
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - SCORING_ML_ENABLED=true
      - SCORING_FUSION_METHOD=bayesian
      - SCORING_ALERT_THRESHOLD=70
      - CUDA_VISIBLE_DEVICES=0
      - ENABLE_GPU=true
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - threat-intel-models:/app/threat_models
    networks:
      - rtcc-network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    profiles:
      - threat-intel
      - gpu

  # =============================================================================
  # Ops Health Monitor (Phase 14)
  # Dedicated service for operational continuity monitoring
  # =============================================================================
  ops-monitor:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rtcc-ops-monitor
    command: python -m app.ops_continuity.monitor
    environment:
      - ENVIRONMENT=development
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-rtcc_neo4j_password}
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - REDIS_URL=redis://redis:6379/0
      - OPS_HEALTH_CHECK_INTERVAL=30
      - OPS_ALERT_WEBHOOK_URL=${OPS_ALERT_WEBHOOK_URL:-}
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - rtcc-network
    restart: unless-stopped
    profiles:
      - monitoring

# =============================================================================
# Networks
# =============================================================================
networks:
  rtcc-network:
    driver: bridge
    name: rtcc-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  neo4j-data:
    name: rtcc-neo4j-data
  neo4j-logs:
    name: rtcc-neo4j-logs
  neo4j-secondary-data:
    name: rtcc-neo4j-secondary-data
  elasticsearch-data:
    name: rtcc-elasticsearch-data
  redis-data:
    name: rtcc-redis-data
  redis-secondary-data:
    name: rtcc-redis-secondary-data
  backend-cache:
    name: rtcc-backend-cache
  frontend-node-modules:
    name: rtcc-frontend-node-modules
  frontend-next:
    name: rtcc-frontend-next
  predictive-models:
    name: rtcc-predictive-models
  building-models:
    name: rtcc-building-models
  threat-intel-models:
    name: rtcc-threat-intel-models
