name: Infrastructure CI

on:
  push:
    branches:
      - main
      - 'devin/*'
    paths:
      - 'infra/**'
      - 'backend/app/infra/**'
      - '.github/workflows/infra-ci.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'infra/**'
      - 'backend/app/infra/**'

env:
  TERRAFORM_VERSION: '1.5.7'
  KUBECTL_VERSION: '1.28.0'

jobs:
  validate-kubernetes:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v${{ env.KUBECTL_VERSION }}

      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin/

      - name: Validate K8s manifests
        run: |
          echo "Validating Kubernetes manifests..."
          for file in infra/kubernetes/*.yaml; do
            echo "Validating $file"
            kubeval --strict "$file" || exit 1
          done
          echo "All Kubernetes manifests are valid!"

      - name: Check for security issues
        run: |
          echo "Checking for security issues in K8s manifests..."
          for file in infra/kubernetes/*.yaml; do
            if grep -q "privileged: true" "$file"; then
              echo "WARNING: Privileged container found in $file"
            fi
            if grep -q "hostNetwork: true" "$file"; then
              echo "WARNING: Host network access found in $file"
            fi
          done

  validate-terraform:
    name: Validate Terraform Configurations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: |
          cd infra/terraform/aws-govcloud
          terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          cd infra/terraform/aws-govcloud
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd infra/terraform/aws-govcloud
          terraform validate

      - name: Check for sensitive data
        run: |
          echo "Checking for hardcoded secrets..."
          if grep -rE "(password|secret|key)\s*=\s*\"[^\"]+\"" infra/terraform/ --include="*.tf" | grep -v "CHANGE_ME"; then
            echo "ERROR: Potential hardcoded secrets found!"
            exit 1
          fi
          echo "No hardcoded secrets found."

  validate-docker:
    name: Validate Docker Configurations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose
        run: |
          cd infra/docker
          docker compose -f docker-compose.prod.yaml config --quiet
          echo "Docker Compose configuration is valid!"

      - name: Check Dockerfile best practices
        run: |
          if [ -f Dockerfile ]; then
            echo "Checking Dockerfile best practices..."
            if grep -q "FROM.*:latest" Dockerfile; then
              echo "WARNING: Using :latest tag in Dockerfile"
            fi
            if ! grep -q "USER" Dockerfile; then
              echo "WARNING: No USER instruction found - container may run as root"
            fi
          fi

  lint-python:
    name: Lint Python Infrastructure Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install ruff mypy

      - name: Run Ruff linter
        run: |
          ruff check backend/app/infra/ --ignore E501

      - name: Run type checking
        run: |
          mypy backend/app/infra/ --ignore-missing-imports --no-error-summary || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'infra/'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Check for exposed secrets
        run: |
          echo "Scanning for exposed secrets..."
          if grep -rE "(api_key|apikey|secret_key|password|token)\s*[:=]\s*['\"][^'\"]+['\"]" infra/ --include="*.yaml" --include="*.yml" --include="*.tf" | grep -v "CHANGE_ME" | grep -v "secretKeyRef"; then
            echo "WARNING: Potential exposed secrets found"
          else
            echo "No exposed secrets found."
          fi

  cjis-compliance-check:
    name: CJIS Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check encryption requirements
        run: |
          echo "Checking CJIS encryption requirements..."
          
          # Check for TLS configuration
          if grep -rq "tls\|TLS\|ssl\|SSL" infra/kubernetes/*.yaml; then
            echo "TLS configuration found"
          else
            echo "WARNING: No TLS configuration found in K8s manifests"
          fi
          
          # Check for encryption at rest
          if grep -rq "encrypt\|Encrypt" infra/terraform/; then
            echo "Encryption at rest configuration found"
          else
            echo "WARNING: No encryption at rest configuration found"
          fi

      - name: Check audit logging
        run: |
          echo "Checking audit logging requirements..."
          if grep -rq "audit\|logging" infra/; then
            echo "Audit logging configuration found"
          else
            echo "WARNING: No audit logging configuration found"
          fi

      - name: Check session timeout
        run: |
          echo "Checking session timeout configuration..."
          if grep -rq "timeout\|idle" infra/; then
            echo "Session timeout configuration found"
          else
            echo "WARNING: No session timeout configuration found"
          fi

  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [validate-kubernetes, validate-terraform, validate-docker, lint-python, security-scan, cjis-compliance-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Infrastructure CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Kubernetes Validation | ${{ needs.validate-kubernetes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validation | ${{ needs.validate-terraform.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Validation | ${{ needs.validate-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Linting | ${{ needs.lint-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CJIS Compliance | ${{ needs.cjis-compliance-check.result }} |" >> $GITHUB_STEP_SUMMARY
