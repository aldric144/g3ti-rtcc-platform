name: Autonomy Engine Self-Test

on:
  push:
    branches:
      - main
      - 'devin/**'
    paths:
      - 'backend/app/city_autonomy/**'
      - 'backend/app/api/city_autonomy/**'
      - 'backend/app/websockets/city_autonomy.py'
      - 'tests/phase24/**'
  pull_request:
    branches:
      - main
    paths:
      - 'backend/app/city_autonomy/**'
      - 'backend/app/api/city_autonomy/**'
      - 'backend/app/websockets/city_autonomy.py'
      - 'tests/phase24/**'
  workflow_dispatch:

jobs:
  autonomy-tests:
    name: Autonomy Engine Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: rtcc
          POSTGRES_PASSWORD: rtcc_test
          POSTGRES_DB: rtcc_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov httpx
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi

      - name: Run Autonomous Action Engine tests
        run: |
          pytest tests/phase24/test_autonomous_action_engine.py -v --tb=short
        env:
          DATABASE_URL: postgresql://rtcc:rtcc_test@localhost:5432/rtcc_test
          REDIS_URL: redis://localhost:6379

      - name: Run Policy Engine tests
        run: |
          pytest tests/phase24/test_policy_engine.py -v --tb=short
        env:
          DATABASE_URL: postgresql://rtcc:rtcc_test@localhost:5432/rtcc_test
          REDIS_URL: redis://localhost:6379

      - name: Run Stabilizer tests
        run: |
          pytest tests/phase24/test_stabilizer.py -v --tb=short
        env:
          DATABASE_URL: postgresql://rtcc:rtcc_test@localhost:5432/rtcc_test
          REDIS_URL: redis://localhost:6379

      - name: Run Risk Scoring tests
        run: |
          pytest tests/phase24/test_risk_scoring.py -v --tb=short
        env:
          DATABASE_URL: postgresql://rtcc:rtcc_test@localhost:5432/rtcc_test
          REDIS_URL: redis://localhost:6379

      - name: Run Explainability tests
        run: |
          pytest tests/phase24/test_explainability.py -v --tb=short
        env:
          DATABASE_URL: postgresql://rtcc:rtcc_test@localhost:5432/rtcc_test
          REDIS_URL: redis://localhost:6379

      - name: Run Approval Workflow tests
        run: |
          pytest tests/phase24/test_approval_workflow.py -v --tb=short
        env:
          DATABASE_URL: postgresql://rtcc:rtcc_test@localhost:5432/rtcc_test
          REDIS_URL: redis://localhost:6379

      - name: Run Autonomy Override tests
        run: |
          pytest tests/phase24/test_autonomy_override.py -v --tb=short
        env:
          DATABASE_URL: postgresql://rtcc:rtcc_test@localhost:5432/rtcc_test
          REDIS_URL: redis://localhost:6379

      - name: Run Audit Chain tests
        run: |
          pytest tests/phase24/test_audit_chain.py -v --tb=short
        env:
          DATABASE_URL: postgresql://rtcc:rtcc_test@localhost:5432/rtcc_test
          REDIS_URL: redis://localhost:6379

      - name: Run API Endpoint tests
        run: |
          pytest tests/phase24/test_autonomy_api.py -v --tb=short
        env:
          DATABASE_URL: postgresql://rtcc:rtcc_test@localhost:5432/rtcc_test
          REDIS_URL: redis://localhost:6379

      - name: Run UI Integration tests
        run: |
          pytest tests/phase24/test_autonomy_ui.py -v --tb=short
        env:
          DATABASE_URL: postgresql://rtcc:rtcc_test@localhost:5432/rtcc_test
          REDIS_URL: redis://localhost:6379

      - name: Run full test suite with coverage
        run: |
          pytest tests/phase24/ -v --cov=backend/app/city_autonomy --cov-report=xml --cov-report=term-missing
        env:
          DATABASE_URL: postgresql://rtcc:rtcc_test@localhost:5432/rtcc_test
          REDIS_URL: redis://localhost:6379

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: autonomy-tests
          name: autonomy-coverage
          fail_ci_if_error: false

  autonomy-integration:
    name: Autonomy Integration Tests
    runs-on: ubuntu-latest
    needs: autonomy-tests
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio httpx
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi

      - name: Test circuit breaker functionality
        run: |
          python -c "
          from backend.app.city_autonomy import get_autonomous_action_engine
          engine = get_autonomous_action_engine()
          
          # Test circuit breaker
          for i in range(6):
              engine._record_failure()
          
          assert engine._circuit_breaker_open, 'Circuit breaker should be open after 5 failures'
          
          engine.reset_circuit_breaker()
          assert not engine._circuit_breaker_open, 'Circuit breaker should be closed after reset'
          
          print('Circuit breaker test passed')
          "

      - name: Test policy hierarchy
        run: |
          python -c "
          from backend.app.city_autonomy.policy_engine import get_policy_engine, PolicyScope
          engine = get_policy_engine()
          
          # Test policy hierarchy
          policies = engine.get_policies()
          assert len(policies) > 0, 'Should have default policies'
          
          # Test emergency overrides
          overrides = engine.get_all_emergency_overrides()
          assert len(overrides) > 0, 'Should have emergency overrides'
          
          print('Policy hierarchy test passed')
          "

      - name: Test audit chain integrity
        run: |
          python -c "
          from backend.app.city_autonomy.audit_engine import get_audit_engine, AuditEventType
          engine = get_audit_engine()
          
          # Log some events
          engine.log_event(
              event_type=AuditEventType.ACTION_CREATED,
              actor_id='test',
              actor_type='system',
              actor_name='Test',
              resource_type='test',
              resource_id='test-001',
              description='Test event',
          )
          
          # Verify chain integrity
          is_valid, errors = engine.verify_chain_integrity()
          assert is_valid, f'Chain integrity should be valid: {errors}'
          
          print('Audit chain integrity test passed')
          "

  autonomy-lint:
    name: Autonomy Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Run ruff linter
        run: |
          ruff check backend/app/city_autonomy/ --ignore E501,F401
        continue-on-error: true

      - name: Run type checking
        run: |
          mypy backend/app/city_autonomy/ --ignore-missing-imports --no-error-summary
        continue-on-error: true
